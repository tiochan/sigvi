<?php
/**
 * @author Sebastian Gomez (tiochan@gmail.com)
 * For: Politechnical University of Catalonia (UPC), Spain.
 *
 * @package sigvi
 * @subpackage reports
 *
 * Vulnerability evolution on the last year (12 months).
 * Echo a png string, creating a graph that indicates how many vulnearbilities
 * have appeared on each month.
 */

	if(!defined("QUIET")) define("QUIET",true);		// Avoid init echos and html includes

	include_once INC_DIR . "/reports/graphs/report_graph.class.php";



	class vulnerability_progress extends report_graph {

		public function render($filename="") {

			global $MESSAGES, $global_db;


			$title=$MESSAGES["VULN_COUNTER"];

			$width= 800;
			$height= 450;


			///////////////////////////////////////////////////////////////////////////
			// Get data
			$query= "select * from (select date_format(vln.publish_date,'%Y/%m') as pd, count(*) from vulnerabilities vln group by pd order by pd desc limit 12) as aux order by pd asc";
			$res= $global_db->dbms_query($query);

			$values= Array();
			$labels= Array();
			$i=0;
			while($row= $global_db->dbms_fetch_row($res)) {
				$labels[$i]= $row[0];
				$values[$i]= $row[1];
				$i++;
			}

			$global_db->dbms_free_result($res);

			if(count($values) == 0) {
				$this->showMessage("No data",$filename);
				return;
			}

			///////////////////////////////////////////////////////////////////////////
			// Create graph

			$graph= new Graph($width, $height, "auto");
			$graph->SetMarginColor("#ffffff");
			$graph->SetScale("textlin");
			$graph->img->SetMargin(60,50,50,10);
			$graph->SetFrameBevel(0,false);
			// $graph->SetShadow();
			$graph->title->Set($title);
			$graph->title->SetFont(FF_FONT2,FS_BOLD);

			// Labels
			$graph->xaxis->title->Set("Month");
			$graph->xaxis->SetTickLabels($labels);
			$graph->xaxis->SetLabelAngle(90);
			$graph->xaxis->SetTextTickInterval(1);

			$graph->yaxis->title->Set("Alerts");

			$graph->yaxis->title->SetFont(FF_FONT1,FS_BOLD);
			$graph->xaxis->title->SetFont(FF_FONT1,FS_BOLD);

			// Line plot, alerts
			$l1plot=new BarPlot($values);
			$l1plot->SetColor("black");
			$l1plot->SetFillColor("#dd6666");
			$l1plot->SetWeight(1);
			$l1plot->SetLegend("Vuln evolution");

			$l1plot->value->Show();
			$l1plot->value->SetFont(FF_FONT1,FS_NORMAL,10);
			$l1plot->value->SetColor("red");
			//$l1plot->value->SetAngle(45);
			$l1plot->value->SetFormat('%d');


			$graph->Add($l1plot);


			$graph->Stroke($filename);

			unset($graph);
		}
	}
?>

<?php
/**
 * @author Sebastian Gomez (tiochan@gmail.com)
 * For: Politechnical University of Catalonia (UPC), Spain.
 *
 * @package sigvi
 * @subpackage reports
 *
 * Vulnerability evolution on the last year (12 months).
 * Echo a png string, creating a graph that indicates how many vulnearbilities
 * have appeared on each month.
 */


	if(!defined("QUIET")) define("QUIET",true);		// Avoid init echos and html includes

	include_once INC_DIR . "/reports/graphs/report_graph.class.php";


	class vulnerability_vs_alert extends report_graph {

		public function render($filename="") {

			global $MESSAGES, $global_db;


			$title=$MESSAGES["ALERTS"] . " vs " . $MESSAGES["VULNERABILITIES"];

			$width= 800;
			$height= 450;


			////////////////////////////////////////////////////////////////////////////
			// Vulnerability graph
			$query= "select * from (select date_format(vln.publish_date,'%Y/%m') as pd, count(*) from vulnerabilities vln group by year(vln.publish_date), month(vln.publish_date) order by pd desc limit 12) as aux order by pd asc";
			$res= $global_db->dbms_query($query);

			$vulns= Array();
			$labels= Array();
			$i=0;
			while($row= $global_db->dbms_fetch_row($res)) {
				$labels[$i]= $row[0];
				$vulns[$i]= $row[1];
				$i++;
			}
			$global_db->dbms_free_result($res);

			////////////////////////////////////////////////////////////////////////////
			// Alerts graph
			if($this->user->level != 0) {
				$query= "select date_format(alerts.creation_date,'%Y/%m') as cd, count(*) from alerts, servers where alerts.id_server=servers.id_server and servers.id_group='" . $this->user->id_group . "' and alerts.status!=5 group by year(creation_date), month(creation_date) order by cd desc limit 12";
				$title.= " (group " . $this->user->group_name . ")";
			} else {
				$query= "select date_format(creation_date,'%Y/%m') as cd, count(*) from alerts where alerts.status!=5 group by year(creation_date), month(creation_date) order by cd asc limit 12";
			}

			$res= $global_db->dbms_query($query);

			$values_tmp= Array();
			$alerts= Array();
			$i=0;
			while($row= $global_db->dbms_fetch_row($res)) {
				$values_tmp[$row[0]]= $row[1];
			}

			foreach($labels as $label) {
				$alerts[] = isset($values_tmp[$label]) ? $values_tmp[$label] : 0;
			}

			$global_db->dbms_free_result($res);

			if( (count($labels) == 0) ) $labels[]="";
			if( (count($vulns) == 0) ) $vulns[]=0;
			if( (count($alerts) == 0) ) $alerts[]=0;

			///////////////////////////////////////////////////////////////////////////
			// Create graph

			$graph= new Graph($width, $height, "auto");
			$graph->SetMarginColor("#ffffff");
			$graph->SetScale("textlin");
			$graph->img->SetMargin(40,130,20,40);
			$graph->SetFrameBevel(0,false);
			// $graph->SetShadow();
			$graph->title->Set($title);
			$graph->title->SetFont(FF_FONT2,FS_BOLD);

			// Labels
			$graph->xaxis->title->Set("Date");
			$graph->xaxis->SetTickLabels($labels);
			$graph->xaxis->SetLabelAngle(90);
			$graph->xaxis->SetTextTickInterval(1);


			$graph->yaxis->title->Set("Vulnerabilities");

			$graph->yaxis->title->SetFont(FF_FONT1,FS_BOLD);
			$graph->xaxis->title->SetFont(FF_FONT1,FS_BOLD);

			// Line plot, vulnerabilities
			$l1plot=new LinePlot($vulns);
			$l1plot->SetColor("#dd6666");
			$l1plot->SetWeight(1);
			$l1plot->SetLegend($MESSAGES["VULNERABILITIES"]);

			$l1plot->value->Show();
			$l1plot->value->SetFont(FF_FONT1,FS_BOLD,10);
			$l1plot->value->SetColor("#ff3333");
			//$l1plot->value->SetAngle(45);
			$l1plot->value->SetFormat('%d');


			$graph->Add($l1plot);

			// Bar plot, alerts
			$l2plot=new BarPlot($alerts);
			$l2plot->SetColor("blue");
			$l2plot->SetFillColor("blue@0.9");
			$l2plot->SetWeight(1);
			$l2plot->SetLegend($MESSAGES["ALERTS"]);

			$l2plot->value->Show();
			$l2plot->value->SetFont(FF_FONT1,FS_NORMAL,10);
			$l2plot->value->SetColor("blue");
			//$l2plot->value->SetAngle(45);
			$l2plot->value->SetFormat('%d');

			$graph->Add($l2plot);


			$graph->Stroke($filename);

			unset($graph);
		}
	}
?>
